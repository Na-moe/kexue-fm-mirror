name: Scrape and Translate Kexue FM Blog using Claude Code

on:
  # æ¯8å°æ—¶è¿è¡Œä¸€æ¬¡
  schedule:
    - cron: '0 */8 * * *'

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

  # push åˆ°ä¸»åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [ main, master ]

# å…è®¸å†™å…¥æƒé™
permissions:
  contents: write
  actions: write
  pages: write
  deployments: write

jobs:
  scrape-and-translate:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        # ä¿æŒå†å²è®°å½•
        fetch-depth: 0
        # ä½¿ç”¨å¸¦ token çš„ URL
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Create tmp directory
      run: |
        mkdir -p tmp

    - name: Get latest blog IDs
      id: get-ids
      uses: anthropics/claude-code-action@v1
      with:
        anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
        prompt: |
          è¯·ä½¿ç”¨ web-reader MCP å·¥å…·è®¿é—® https://kexue.fm/

          ä»»åŠ¡ï¼š
          1. è¯»å–ç½‘ç«™å†…å®¹ï¼Œæ‰¾åˆ°æœ€æ–°20ç¯‡åšå®¢æ–‡ç« 
          2. æå–æ¯ç¯‡æ–‡ç« çš„IDï¼ˆé€šå¸¸åœ¨URLä¸­ï¼Œå¦‚ /archives/12345ï¼‰
          3. å°†IDåˆ—è¡¨ä¿å­˜åˆ° tmp/latest_ids.md æ–‡ä»¶ä¸­
          4. æ¯è¡Œåªå†™ä¸€ä¸ªIDï¼Œä»æœ€æ–°åˆ°æœ€æ—§æ’åº

          æ³¨æ„ï¼š
          - ç¡®ä¿è·å–çš„æ˜¯çœŸå®çš„æ–‡ç« IDï¼Œä¸æ˜¯å…¶ä»–æ•°å­—
          - å¦‚æœæ— æ³•ä»ä¸»é¡µè·å–ï¼Œå°è¯•è®¿é—®æ–‡ç« åˆ—è¡¨é¡µ
          - ä¿å­˜æ ¼å¼ç¤ºä¾‹ï¼š
            11459
            11428
            11416
            ...

    - name: Check for missing articles
      id: check-missing
      uses: anthropics/claude-code-action@v1
      with:
        anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
        prompt: |
          è¯·æ‰§è¡Œä»¥ä¸‹ä»»åŠ¡ï¼š

          1. è¯»å– tmp/latest_ids.md ä¸­çš„IDåˆ—è¡¨
          2. æ£€æŸ¥ kexue_fm_zh_cn/ ç›®å½•ä¸‹å“ªäº›IDå¯¹åº”çš„ .md æ–‡ä»¶ä¸å­˜åœ¨
          3. å°†ç¼ºå¤±çš„IDåˆ—è¡¨ä¿å­˜åˆ° tmp/missing_ids.md
          4. å¦‚æœæ²¡æœ‰ç¼ºå¤±çš„æ–‡ç« ï¼Œåˆ›å»ºä¸€ä¸ªç©ºçš„ tmp/missing_ids.md æ–‡ä»¶

          æ³¨æ„ï¼š
          - åªæ£€æŸ¥æ–‡ä»¶åï¼Œä¸éœ€è¦è¯»å–å†…å®¹
          - æ¯è¡Œä¸€ä¸ªID
          - ä¿æŒåŸé¡ºåº

    - name: Scrape new articles
      if: steps.check-missing.outputs.changed == 'true'
      uses: anthropics/claude-code-action@v1
      with:
        anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
        prompt: |
          è¯·æ‰§è¡Œä»¥ä¸‹ä»»åŠ¡ï¼š

          1. è¯»å– tmp/missing_ids.md ä¸­çš„IDåˆ—è¡¨
          2. å¯¹æ¯ä¸ªIDï¼Œä½¿ç”¨ web-reader MCP å·¥å…·è®¿é—® https://kexue.fm/archives/{id}
          3. æå–æ–‡ç« çš„å®Œæ•´å†…å®¹ï¼ŒåŒ…æ‹¬æ ‡é¢˜å’Œæ­£æ–‡
          4. å°†æ¯ç¯‡æ–‡ç« ä¿å­˜ä¸º kexue_fm_zh_cn/{id}.md

          ä¿å­˜æ ¼å¼ï¼š
          ```markdown
          # {æ–‡ç« æ ‡é¢˜}

          **åŸæ–‡é“¾æ¥**: https://kexue.fm/archives/{id}
          **çˆ¬å–æ—¶é—´**: {å½“å‰æ—¶é—´}

          ---

          {æ–‡ç« æ­£æ–‡å†…å®¹}
          ```

          æ³¨æ„ï¼š
          - ä¿æŒmarkdownæ ¼å¼
          - ç¡®ä¿å†…å®¹å®Œæ•´
          - å¦‚æœæŸä¸ªæ–‡ç« æ— æ³•è®¿é—®ï¼Œè®°å½•ä¸‹æ¥ä½†ç»§ç»­å¤„ç†å…¶ä»–æ–‡ç« 

    - name: Translate articles to English
      if: steps.check-missing.outputs.changed == 'true'
      uses: anthropics/claude-code-action@v1
      with:
        anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
        prompt: |
          è¯·æ‰§è¡Œç¿»è¯‘ä»»åŠ¡ï¼š

          1. è¯»å– tmp/missing_ids.md ä¸­çš„IDåˆ—è¡¨
          2. å¯¹æ¯ä¸ªIDï¼š
             - è¯»å– kexue_fm_zh_cn/{id}.md
             - å°†ä¸­æ–‡å†…å®¹ç¿»è¯‘æˆè‹±æ–‡
             - ä¿æŒmarkdownæ ¼å¼å’Œç»“æ„
             - ä¿å­˜åˆ° kexue_fm_en_us/{id}.md

          ç¿»è¯‘è¦æ±‚ï¼š
          - å‡†ç¡®ç¿»è¯‘æŠ€æœ¯æœ¯è¯­
          - ä¿æŒåŸæ–‡çš„ä¸“ä¸šæ€§
          - ä¸è¦ç¿»è¯‘ä»£ç å—
          - ä¿ç•™æ‰€æœ‰é“¾æ¥å’Œå¼•ç”¨
          - åœ¨æ–‡ä»¶å¼€å¤´æ·»åŠ ç¿»è¯‘ä¿¡æ¯

          è‹±æ–‡æ–‡ä»¶æ ¼å¼ï¼š
          ```markdown
          # (Translated from Chinese)

          **Original ID**: {id}
          **Original URL**: https://kexue.fm/archives/{id}
          **Translation Date**: {å½“å‰æ—¶é—´}

          ---

          {ç¿»è¯‘åçš„è‹±æ–‡å†…å®¹}
          ```

    - name: Check if there are changes to commit
      id: check-changes
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "Found changes to commit"
        else
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "No changes to commit"
        fi

    - name: Commit and push changes
      if: steps.check-changes.outputs.has_changes == 'true'
      run: |
        # é…ç½® Git
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

        # æ·»åŠ æ‰€æœ‰æ›´æ”¹
        git add --all

        # è·å–å½“å‰æ—¥æœŸ
        DATE=$(date +'%Y-%m-%d %H:%M:%S')

        # æäº¤æ›´æ”¹
        git commit -m "Update blog posts - $DATE

        ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

        Co-Authored-By: GitHub Actions <actions@github.com>"

        # æ¨é€æ›´æ”¹
        # ä½¿ç”¨å¸¦ token çš„ URL é¿å… 403 é”™è¯¯
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
        git push origin master

    - name: Create summary
      run: |
        echo "## Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # ç»Ÿè®¡ä¸­æ–‡æ–‡ç« æ•°é‡
        CN_COUNT=$(find kexue_fm_zh_cn -name "*.md" 2>/dev/null | wc -l)
        echo "- ä¸­æ–‡æ–‡ç« æ•°é‡: $CN_COUNT" >> $GITHUB_STEP_SUMMARY

        # ç»Ÿè®¡è‹±æ–‡æ–‡ç« æ•°é‡
        EN_COUNT=$(find kexue_fm_en_us -name "*.md" 2>/dev/null | wc -l)
        echo "- è‹±æ–‡æ–‡ç« æ•°é‡: $EN_COUNT" >> $GITHUB_STEP_SUMMARY

        # æ˜¾ç¤ºæœ€æ–°æ–‡ç« 
        if [ $CN_COUNT -gt 0 ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æœ€æ–°çš„ä¸­æ–‡æ–‡ç« " >> $GITHUB_STEP_SUMMARY
          ls -lt kexue_fm_zh_cn/*.md 2>/dev/null | head -5 | while read file; do
            filename=$(basename "$file")
            echo "- $filename" >> $GITHUB_STEP_SUMMARY
          done
        fi

        if [ $EN_COUNT -gt 0 ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æœ€æ–°çš„è‹±æ–‡æ–‡ç« " >> $GITHUB_STEP_SUMMARY
          ls -lt kexue_fm_en_us/*.md 2>/dev/null | head -5 | while read file; do
            filename=$(basename "$file")
            echo "- $filename" >> $GITHUB_STEP_SUMMARY
          done
        fi

        # æ˜¾ç¤ºå¤„ç†ä¿¡æ¯
        if [ -f "tmp/latest_ids.md" ]; then
          LATEST_COUNT=$(cat tmp/latest_ids.md 2>/dev/null | wc -l)
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### å¤„ç†ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- æ£€æµ‹åˆ°çš„æœ€æ–°æ–‡ç« æ•°: $LATEST_COUNT" >> $GITHUB_STEP_SUMMARY

          if [ -f "tmp/missing_ids.md" ]; then
            MISSING_COUNT=$(cat tmp/missing_ids.md 2>/dev/null | wc -l)
            echo "- æ–°å¢æ–‡ç« æ•°: $MISSING_COUNT" >> $GITHUB_STEP_SUMMARY
          fi
        fi

    - name: Notification on failure
      if: failure()
      run: |
        echo "Workflow failed! Please check the logs for details."
        echo "Failed at step: ${{ job.status }}"