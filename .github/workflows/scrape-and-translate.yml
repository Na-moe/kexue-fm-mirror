name: Scrape and Translate Kexue FM Blog

on:
  # æ¯å¤© UTC 10:00 è¿è¡Œä¸€æ¬¡ï¼ˆåŒ—äº¬æ—¶é—´ 18:00ï¼‰
  schedule:
    - cron: '0 10 * * *'

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

  # push åˆ°ä¸»åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [ main, master ]

jobs:
  scrape-and-translate:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        # ä¿æŒå†å²è®°å½•
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 html2text markdown

    - name: Install claude-code-actions
      run: |
        npm install -g @anthropic-ai/claude-code-actions
      continue-on-error: true

    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

    - name: Scrape new blog posts
      run: |
        python scrape_kexue.py
      env:
        # è®¾ç½®ç¯å¢ƒå˜é‡
        PYTHONUNBUFFERED: 1

    - name: Check for new posts
      id: check-posts
      run: |
        if [ -n "$(git status --porcelain kexue_fm_zh_cn/)" ]; then
          echo "new_posts=true" >> $GITHUB_OUTPUT
          echo "Found new Chinese posts to translate"
        else
          echo "new_posts=false" >> $GITHUB_OUTPUT
          echo "No new posts found"
        fi

    - name: Translate posts to English
      if: steps.check-posts.outputs.new_posts == 'true'
      run: |
        # å°è¯•ä½¿ç”¨ claude-code-actions è¿›è¡Œç¿»è¯‘
        python translate_posts.py
      env:
        # å¦‚æœéœ€è¦ API keyï¼Œåœ¨è¿™é‡Œé…ç½®
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      continue-on-error: true

    - name: Alternative translation using GitHub API
      if: steps.check-posts.outputs.new_posts == 'true'
      run: |
        # å¦‚æœ claude-code-actions ä¸å¯ç”¨ï¼Œä½¿ç”¨ GitHub API è¿›è¡Œç¿»è¯‘
        python translate_with_github_api.py
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true

    - name: Commit and push changes
      if: steps.check-posts.outputs.new_posts == 'true'
      run: |
        # æ·»åŠ æ‰€æœ‰æ›´æ”¹
        git add --all

        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
        if git diff --cached --quiet; then
          echo "No changes to commit"
        else
          # è·å–å½“å‰æ—¥æœŸ
          DATE=$(date +'%Y-%m-%d %H:%M:%S')

          # æäº¤æ›´æ”¹
          git commit -m "Update blog posts - $DATE

          ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: GitHub Actions <actions@github.com>"

          # æ¨é€æ›´æ”¹
          git push
        fi

    - name: Create summary
      run: |
        echo "## Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # ç»Ÿè®¡ä¸­æ–‡æ–‡ç« æ•°é‡
        CN_COUNT=$(find kexue_fm_zh_cn -name "*.md" 2>/dev/null | wc -l)
        echo "- ä¸­æ–‡æ–‡ç« æ•°é‡: $CN_COUNT" >> $GITHUB_STEP_SUMMARY

        # ç»Ÿè®¡è‹±æ–‡æ–‡ç« æ•°é‡
        EN_COUNT=$(find kexue_fm_en_us -name "*.md" 2>/dev/null | wc -l)
        echo "- è‹±æ–‡æ–‡ç« æ•°é‡: $EN_COUNT" >> $GITHUB_STEP_SUMMARY

        # æ˜¾ç¤ºæœ€æ–°æ–‡ç« 
        if [ $CN_COUNT -gt 0 ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æœ€æ–°çš„ä¸­æ–‡æ–‡ç« " >> $GITHUB_STEP_SUMMARY
          ls -lt kexue_fm_zh_cn/*.md 2>/dev/null | head -5 | while read file; do
            filename=$(basename "$file")
            echo "- $filename" >> $GITHUB_STEP_SUMMARY
          done
        fi

        if [ $EN_COUNT -gt 0 ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æœ€æ–°çš„è‹±æ–‡æ–‡ç« " >> $GITHUB_STEP_SUMMARY
          ls -lt kexue_fm_en_us/*.md 2>/dev/null | head -5 | while read file; do
            filename=$(basename "$file")
            echo "- $filename" >> $GITHUB_STEP_SUMMARY
          done
        fi

    - name: Notification on failure
      if: failure()
      run: |
        echo "Workflow failed! Please check the logs for details."
        echo "Failed at step: ${{ job.status }}"